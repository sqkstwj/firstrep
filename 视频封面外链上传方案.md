# ğŸ¬ è§†é¢‘å°é¢å¤–é“¾ä¸Šä¼ å®Œæ•´æ–¹æ¡ˆ

## ğŸ” **å½“å‰è§†é¢‘å°é¢æœºåˆ¶åˆ†æ**

### 1. é‡è¦å‘ç°
ç»è¿‡æ·±å…¥åˆ†æï¼Œ**è¿™ä¸ªé¡¹ç›®ç›®å‰æ²¡æœ‰ç‹¬ç«‹çš„è§†é¢‘å°é¢ä¸Šä¼ åŠŸèƒ½**ï¼

### 2. ç°æœ‰è§†é¢‘å¤„ç†æœºåˆ¶
```
è§†é¢‘ä¸Šä¼  â†’ è…¾è®¯äº‘VOD â†’ è‡ªåŠ¨è½¬ç  â†’ ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆå°é¢å¸§
```

**å…³é”®ç‰¹ç‚¹**ï¼š
- **æ— ç‹¬ç«‹å°é¢å­—æ®µ**ï¼š`kg_chapter_vod` è¡¨ä¸­æ²¡æœ‰ä¸“é—¨çš„å°é¢å­—æ®µ
- **è‡ªåŠ¨ç”Ÿæˆ**ï¼šè…¾è®¯äº‘VODåœ¨è½¬ç æ—¶ä¼šè‡ªåŠ¨ç”Ÿæˆè§†é¢‘å°é¢å¸§
- **ä¸¤ç§è§†é¢‘æº**ï¼š
  - è…¾è®¯äº‘VODï¼šå­˜å‚¨åœ¨ `file_id` + `file_transcode`
  - å¤–é“¾è§†é¢‘ï¼šå­˜å‚¨åœ¨ `file_remote` å­—æ®µ

### 3. ç°æœ‰è§†é¢‘å¤–é“¾ç»“æ„
```json
{
  "hd": {"url": "é«˜æ¸…è§†é¢‘åœ°å€"},
  "sd": {"url": "æ ‡æ¸…è§†é¢‘åœ°å€"}, 
  "fd": {"url": "æµç•…è§†é¢‘åœ°å€"},
  "duration": {"hours": 0, "minutes": 45, "seconds": 0}
}
```

## ğŸš€ **è§†é¢‘å°é¢å¤–é“¾è§£å†³æ–¹æ¡ˆ**

### æ–¹æ¡ˆä¸€ï¼šæ‰©å±• file_remote ç»“æ„ï¼ˆæ¨èï¼‰

#### 1.1 æ•°æ®åº“ç»“æ„æ‰©å±•
åœ¨ç°æœ‰çš„ `file_remote` JSONç»“æ„ä¸­æ·»åŠ å°é¢å­—æ®µï¼š

```json
{
  "hd": {"url": "é«˜æ¸…è§†é¢‘åœ°å€"},
  "sd": {"url": "æ ‡æ¸…è§†é¢‘åœ°å€"},
  "fd": {"url": "æµç•…è§†é¢‘åœ°å€"},
  "duration": {"hours": 0, "minutes": 45, "seconds": 0},
  "cover": {
    "url": "http://192.168.1.24:9000/course-files/covers/video-cover.jpg",
    "width": 640,
    "height": 360
  }
}
```

#### 1.2 åå°ç•Œé¢æ‰©å±•
ä¿®æ”¹ `edit_lesson_vod.volt` æ·»åŠ å°é¢è¾“å…¥ï¼š

```html
<!-- åœ¨å¤–é“¾è§†é¢‘è¡¨å•ä¸­æ·»åŠ  -->
<div class="layui-form-item">
    <label class="layui-form-label">è§†é¢‘å°é¢</label>
    <div class="layui-inline" style="width:55%;">
        <input id="video-cover-url" class="layui-input" type="text" 
               name="file_remote[cover][url]" 
               value="{{ remote_play_urls.cover.url ?? '' }}"
               placeholder="è¯·è¾“å…¥è§†é¢‘å°é¢å›¾ç‰‡åœ°å€">
    </div>
    <div class="layui-inline">
        <button type="button" class="layui-btn layui-btn-sm" onclick="previewCover()">é¢„è§ˆ</button>
        <button type="button" class="layui-btn layui-btn-sm layui-btn-normal" onclick="testCoverLink()">æµ‹è¯•</button>
    </div>
</div>
```

### æ–¹æ¡ˆäºŒï¼šæ·»åŠ ç‹¬ç«‹å°é¢å­—æ®µ

#### 2.1 æ•°æ®åº“è¿ç§»
```sql
-- ä¸º kg_chapter_vod è¡¨æ·»åŠ å°é¢å­—æ®µ
ALTER TABLE kg_chapter_vod 
ADD COLUMN cover_url VARCHAR(500) DEFAULT '' COMMENT 'è§†é¢‘å°é¢åœ°å€' 
AFTER file_remote;

-- æ·»åŠ ç´¢å¼•
ALTER TABLE kg_chapter_vod 
ADD INDEX idx_cover_url (cover_url);
```

#### 2.2 æ¨¡å‹æ‰©å±•
ä¿®æ”¹ `ChapterVod.php` æ¨¡å‹ï¼š

```php
/**
 * è§†é¢‘å°é¢
 *
 * @var string
 */
public $cover_url = '';

public function afterFetch()
{
    // ... ç°æœ‰ä»£ç  ...
    
    // å¤„ç†å°é¢URL
    if (!empty($this->cover_url) && !Text::startsWith($this->cover_url, 'http')) {
        $this->cover_url = kg_cos_img_url($this->cover_url);
    }
}
```

### æ–¹æ¡ˆä¸‰ï¼šå‰ç«¯æ˜¾ç¤ºæ‰©å±•

#### 3.1 è§†é¢‘æ’­æ”¾å™¨å°é¢
ä¿®æ”¹è§†é¢‘æ’­æ”¾ç›¸å…³æ¨¡æ¿ï¼Œæ·»åŠ å°é¢æ˜¾ç¤ºï¼š

```html
<!-- è§†é¢‘æ’­æ”¾å™¨ -->
<video id="video-player" 
       poster="{{ chapter.vod.cover_url ?? chapter.vod.file_remote.cover.url ?? '' }}"
       controls>
    <source src="{{ video_url }}" type="video/mp4">
</video>
```

#### 3.2 è¯¾ç¨‹åˆ—è¡¨å°é¢
åœ¨è¯¾ç¨‹ç« èŠ‚åˆ—è¡¨ä¸­æ˜¾ç¤ºè§†é¢‘å°é¢ï¼š

```html
<div class="chapter-item">
    <div class="chapter-cover">
        <img src="{{ chapter.cover_url }}" alt="è§†é¢‘å°é¢">
        <div class="play-btn">â–¶</div>
    </div>
    <div class="chapter-info">
        <h4>{{ chapter.title }}</h4>
        <p>æ—¶é•¿ï¼š{{ chapter.duration }}</p>
    </div>
</div>
```

## ğŸ’» **å®æ–½è„šæœ¬**

### è„šæœ¬1ï¼šæ‰¹é‡è®¾ç½®è§†é¢‘å°é¢
```php
<?php
// video_cover_external.php
```

### è„šæœ¬2ï¼šè‡ªåŠ¨ç”Ÿæˆè§†é¢‘å°é¢
```php
<?php  
// auto_generate_video_cover.php
```

## ğŸ¯ **æ¨èå®æ–½æ­¥éª¤**

### é˜¶æ®µä¸€ï¼šå¿«é€Ÿå®ç°ï¼ˆ1å°æ—¶ï¼‰
1. **æ‰©å±• file_remote ç»“æ„**ï¼šæ·»åŠ  cover å­—æ®µ
2. **åå°ç•Œé¢ä¿®æ”¹**ï¼šåœ¨å¤–é“¾è§†é¢‘è¡¨å•ä¸­æ·»åŠ å°é¢è¾“å…¥
3. **å‰ç«¯æ˜¾ç¤ºä¿®æ”¹**ï¼šåœ¨è§†é¢‘æ’­æ”¾å™¨ä¸­æ˜¾ç¤ºå°é¢

### é˜¶æ®µäºŒï¼šå®Œå–„åŠŸèƒ½ï¼ˆåŠå¤©ï¼‰
1. **æ·»åŠ å°é¢é¢„è§ˆ**ï¼šå®æ—¶é¢„è§ˆå°é¢æ•ˆæœ
2. **å°é¢æµ‹è¯•åŠŸèƒ½**ï¼šéªŒè¯å°é¢é“¾æ¥æœ‰æ•ˆæ€§
3. **æ‰¹é‡è®¾ç½®å·¥å…·**ï¼šPHPè„šæœ¬æ‰¹é‡è®¾ç½®å°é¢

### é˜¶æ®µä¸‰ï¼šé«˜çº§åŠŸèƒ½ï¼ˆ1å¤©ï¼‰
1. **è‡ªåŠ¨å°é¢æå–**ï¼šä»è§†é¢‘ä¸­è‡ªåŠ¨æˆªå–å°é¢
2. **å°é¢ç®¡ç†ç•Œé¢**ï¼šä¸“é—¨çš„å°é¢ç®¡ç†åŠŸèƒ½
3. **å°é¢ä¼˜åŒ–**ï¼šå°ºå¯¸è°ƒæ•´ã€æ ¼å¼è½¬æ¢ç­‰

## âš ï¸ **é‡è¦è¯´æ˜**

### 1. ç°çŠ¶åˆ†æ
- **æ— åŸç”Ÿæ”¯æŒ**ï¼šé¡¹ç›®åŸæœ¬æ²¡æœ‰è§†é¢‘å°é¢åŠŸèƒ½
- **è…¾è®¯äº‘è‡ªåŠ¨**ï¼šè…¾è®¯äº‘VODä¼šè‡ªåŠ¨ç”Ÿæˆå°é¢å¸§
- **å¤–é“¾è§†é¢‘**ï¼šéœ€è¦æ‰‹åŠ¨æŒ‡å®šå°é¢

### 2. æŠ€æœ¯è¦ç‚¹
- **JSONå­˜å‚¨**ï¼šåˆ©ç”¨ç°æœ‰çš„ `file_remote` JSONå­—æ®µ
- **å‘åå…¼å®¹**ï¼šä¸å½±å“ç°æœ‰åŠŸèƒ½
- **æ¸è¿›å¢å¼º**ï¼šå¯ä»¥é€æ­¥å®Œå–„åŠŸèƒ½

### 3. å°é¢è¦æ±‚
- **æ ¼å¼æ”¯æŒ**ï¼šJPG, PNG, GIF
- **æ¨èå°ºå¯¸**ï¼š16:9æ¯”ä¾‹ï¼Œå¦‚ 640x360, 1280x720
- **æ–‡ä»¶å¤§å°**ï¼šå»ºè®®ä¸è¶…è¿‡500KB
- **è®¿é—®è¦æ±‚**ï¼šå¿…é¡»å¯å…¬å¼€è®¿é—®

## ğŸ”§ **æŠ€æœ¯å®ç°ç»†èŠ‚**

### 1. åç«¯å¤„ç†
```php
// åœ¨ ChapterContent.php ä¸­æ‰©å±•
protected function updateRemoteChapterVod(ChapterModel $chapter)
{
    $post = $this->request->getPost();
    
    // ... ç°æœ‰ä»£ç  ...
    
    // å¤„ç†å°é¢
    $coverUrl = $post['file_remote']['cover']['url'] ?? '';
    if (!empty($coverUrl)) {
        $fileRemote['cover'] = [
            'url' => $validator->checkFileUrl($coverUrl),
            'width' => $post['file_remote']['cover']['width'] ?? 640,
            'height' => $post['file_remote']['cover']['height'] ?? 360
        ];
    }
    
    // ... ç°æœ‰ä»£ç  ...
}
```

### 2. å‰ç«¯JavaScript
```javascript
// å°é¢é¢„è§ˆåŠŸèƒ½
function previewCover() {
    var coverUrl = $('#video-cover-url').val();
    if (coverUrl) {
        layer.photos({
            photos: {
                "title": "è§†é¢‘å°é¢é¢„è§ˆ",
                "data": [{"src": coverUrl, "alt": "è§†é¢‘å°é¢"}]
            }
        });
    } else {
        layer.msg('è¯·å…ˆè¾“å…¥å°é¢åœ°å€', {icon: 2});
    }
}

// å°é¢é“¾æ¥æµ‹è¯•
function testCoverLink() {
    var coverUrl = $('#video-cover-url').val();
    if (!coverUrl) {
        layer.msg('è¯·å…ˆè¾“å…¥å°é¢åœ°å€', {icon: 2});
        return;
    }
    
    var img = new Image();
    var loading = layer.load(2, {content: 'æ­£åœ¨æµ‹è¯•å°é¢é“¾æ¥...'});
    
    img.onload = function() {
        layer.close(loading);
        layer.msg('å°é¢é“¾æ¥æœ‰æ•ˆ (' + this.width + 'x' + this.height + ')', {icon: 1});
    };
    
    img.onerror = function() {
        layer.close(loading);
        layer.msg('å°é¢é“¾æ¥æ— æ•ˆæˆ–æ— æ³•è®¿é—®', {icon: 2});
    };
    
    img.src = coverUrl;
}
```

### 3. æ ·å¼ä¼˜åŒ–
```css
/* è§†é¢‘å°é¢æ ·å¼ */
.chapter-cover {
    position: relative;
    width: 160px;
    height: 90px;
    overflow: hidden;
    border-radius: 4px;
}

.chapter-cover img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.play-btn {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 40px;
    height: 40px;
    background: rgba(0,0,0,0.7);
    border-radius: 50%;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
}
```

## ğŸ“‹ **å¿«é€Ÿå¼€å§‹æ¸…å•**

### âœ… **å‡†å¤‡å·¥ä½œ**
- [ ] å‡†å¤‡è§†é¢‘å°é¢å›¾ç‰‡ï¼ˆ16:9æ¯”ä¾‹ï¼‰
- [ ] ä¸Šä¼ åˆ°MinIOæˆ–å›¾åºŠæœåŠ¡
- [ ] è·å–å°é¢å¤–é“¾åœ°å€
- [ ] ç¡®ä¿é“¾æ¥å¯å…¬å¼€è®¿é—®

### âœ… **å®æ–½æ­¥éª¤**
1. **ä¿®æ”¹æ•°æ®ç»“æ„**ï¼šæ‰©å±• `file_remote` å­—æ®µ
2. **æ›´æ–°åå°ç•Œé¢**ï¼šæ·»åŠ å°é¢è¾“å…¥æ¡†
3. **ä¿®æ”¹å‰ç«¯æ˜¾ç¤º**ï¼šåœ¨æ’­æ”¾å™¨ä¸­æ˜¾ç¤ºå°é¢
4. **æµ‹è¯•åŠŸèƒ½**ï¼šéªŒè¯å°é¢æ˜¾ç¤ºæ•ˆæœ
5. **æ‰¹é‡è®¾ç½®**ï¼šä½¿ç”¨è„šæœ¬æ‰¹é‡è®¾ç½®ç°æœ‰è§†é¢‘

### âœ… **éªŒè¯æ•ˆæœ**
- [ ] åå°å¯ä»¥è¾“å…¥å°é¢åœ°å€
- [ ] å°é¢é¢„è§ˆåŠŸèƒ½æ­£å¸¸
- [ ] è§†é¢‘æ’­æ”¾å™¨æ˜¾ç¤ºå°é¢
- [ ] è¯¾ç¨‹åˆ—è¡¨æ˜¾ç¤ºå°é¢ç¼©ç•¥å›¾

---

**æ€»ç»“**ï¼šè™½ç„¶é¡¹ç›®åŸæœ¬æ²¡æœ‰è§†é¢‘å°é¢åŠŸèƒ½ï¼Œä½†é€šè¿‡æ‰©å±•ç°æœ‰çš„ `file_remote` ç»“æ„ï¼Œå¯ä»¥å¾ˆå¥½åœ°å®ç°è§†é¢‘å°é¢å¤–é“¾ä¸Šä¼ åŠŸèƒ½ï¼Œä¸”ä¸å½±å“ç°æœ‰ç³»ç»Ÿçš„ç¨³å®šæ€§ã€‚

éœ€è¦æˆ‘ä¸ºæ‚¨åˆ›å»ºå…·ä½“çš„å®æ–½è„šæœ¬å—ï¼Ÿ
# 测试脚本运行指南

## 📋 准备工作

### 1. 确认环境要求
- PHP 7.3 或更高版本
- 能够访问酷瓜云课堂数据库
- 能够访问MinIO服务器

### 2. 获取必要信息
在运行脚本前，您需要准备以下信息：

#### MinIO信息：
- MinIO服务器地址（如：http://192.168.1.100:9000）
- Bucket名称（如：videos）

#### 数据库信息：
- 数据库主机地址（如：localhost）
- 数据库端口（通常是3306）
- 数据库名称（通常是ctc）
- 数据库用户名和密码

## 🚀 运行方法

### 方法一：在酷瓜云课堂服务器上运行（推荐）

#### 步骤1：上传文件
将以下文件上传到服务器：
```
test_connection.php
minio_external_link.php
外链操作指南.md
```

#### 步骤2：修改配置
编辑 `test_connection.php` 文件，修改配置部分：

```php
$config = [
    'minio' => [
        'endpoint' => 'http://你的MinIO地址:9000',  // 替换为实际地址
        'bucket' => '你的bucket名称'                // 替换为实际bucket
    ],
    'database' => [
        'host' => 'localhost',        // 数据库主机，通常是localhost
        'port' => 3306,              // 数据库端口
        'dbname' => 'ctc',           // 数据库名称
        'username' => 'ctc',         // 数据库用户名
        'password' => '你的数据库密码'  // 数据库密码
    ]
];
```

#### 步骤3：运行测试
```bash
# 进入文件所在目录
cd /path/to/your/files

# 运行测试脚本
php test_connection.php
```

#### 步骤4：查看结果
正常情况下会看到类似输出：
```
连接测试工具
============

1. 测试数据库连接...
   ✓ 数据库连接成功
   ✓ 找到 5 个点播章节

2. 测试MinIO连接...
   测试地址: http://192.168.1.100:9000/videos/
   ✓ MinIO服务器可访问 (HTTP 200)
   ✓ Bucket访问正常

3. 当前配置信息:
   MinIO地址: http://192.168.1.100:9000
   MinIO Bucket: videos
   数据库主机: localhost:3306
   数据库名称: ctc

4. 示例外链地址:
   如果您的视频路径是: course1/lesson1.mp4
   生成的外链地址是: http://192.168.1.100:9000/videos/course1/lesson1.mp4

=== 测试完成 ===
如果以上测试都通过，您可以继续使用 minio_external_link.php 脚本
```

### 方法二：使用Docker运行PHP

如果您的环境没有PHP，可以使用Docker：

#### 步骤1：安装Docker
```bash
# Ubuntu/Debian
sudo apt update
sudo apt install docker.io

# CentOS/RHEL
sudo yum install docker
```

#### 步骤2：运行PHP容器
```bash
# 进入文件所在目录
cd /path/to/your/files

# 使用Docker运行PHP脚本
docker run --rm -v $(pwd):/app -w /app php:7.4-cli php test_connection.php
```

### 方法三：在Windows环境运行

#### 步骤1：安装PHP
1. 下载PHP：https://windows.php.net/download/
2. 解压到如 `C:\php` 目录
3. 将 `C:\php` 添加到系统PATH环境变量

#### 步骤2：运行脚本
```cmd
# 打开命令提示符
# 进入文件所在目录
cd C:\path\to\your\files

# 运行测试脚本
php test_connection.php
```

### 方法四：在线PHP环境

如果以上方法都不可行，可以使用在线PHP环境：

1. 访问在线PHP运行器（如：https://onecompiler.com/php）
2. 复制脚本内容到在线编辑器
3. 修改配置信息
4. 点击运行

## 🔧 常见问题解决

### Q1: "php: command not found"
**解决方法：**
- 安装PHP：`sudo apt install php-cli php-mysql`
- 或使用Docker方法运行

### Q2: "PDO extension not found"
**解决方法：**
```bash
# Ubuntu/Debian
sudo apt install php-mysql php-pdo

# CentOS/RHEL
sudo yum install php-mysql php-pdo
```

### Q3: "curl extension not found"
**解决方法：**
```bash
# Ubuntu/Debian
sudo apt install php-curl

# CentOS/RHEL
sudo yum install php-curl
```

### Q4: 数据库连接失败
**可能原因和解决方法：**
- 检查数据库服务是否启动
- 确认用户名密码是否正确
- 检查防火墙设置
- 确认PHP有访问数据库的权限

### Q5: MinIO连接失败
**可能原因和解决方法：**
- 检查MinIO服务是否启动
- 确认地址和端口是否正确
- 检查网络连接是否正常
- 确认MinIO允许外部访问

## 📊 测试结果说明

### 成功的输出示例：
```
✓ 数据库连接成功          # 数据库配置正确
✓ 找到 X 个点播章节       # 系统中有可用的章节
✓ MinIO服务器可访问       # MinIO服务正常
✓ Bucket访问正常          # Bucket配置正确
```

### 失败的输出示例：
```
✗ 数据库连接失败: Access denied    # 用户名密码错误
✗ MinIO服务器无法访问 (HTTP 0)     # 网络不通或地址错误
```

## 🎯 下一步操作

测试通过后，您可以：

1. **配置视频列表**：编辑 `minio_external_link.php` 中的 `$videoList` 数组
2. **运行主脚本**：`php minio_external_link.php`
3. **验证结果**：在后台查看章节是否正确关联视频

## 💡 小贴士

1. **备份数据库**：运行脚本前建议备份数据库
2. **测试环境**：先在测试环境验证，再在生产环境使用
3. **分批处理**：如果视频很多，建议分批处理
4. **记录日志**：保存脚本执行的输出日志，便于问题排查

---

**需要帮助？** 如果遇到问题，请提供：
- 操作系统版本
- PHP版本信息
- 错误信息截图
- 配置信息（隐藏敏感信息）
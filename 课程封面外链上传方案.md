# 📸 课程封面外链上传方案

## 🔍 **当前封面上传机制分析**

### 1. 现有上传流程
```
前端页面 → 点击"更换"按钮 → Layui上传组件 → /admin/upload/cover/img → 腾讯云COS → 返回URL
```

### 2. 关键文件分析
- **前端**: `edit_basic.volt` - 封面显示和更换按钮
- **JavaScript**: `cover.upload.js` - 处理上传逻辑
- **后端**: `UploadController::uploadCoverImageAction()` - 上传接口
- **存储**: 腾讯云COS存储，路径格式：`/img/cover/xxx.jpg`
- **数据库**: `kg_course.cover` 字段存储相对路径

### 3. 封面处理机制
```php
// 保存时：如果是完整URL，提取路径部分
beforeSave() {
    if (Text::startsWith($this->cover, 'http')) {
        $this->cover = self::getCoverPath($this->cover);  // 提取路径
    }
}

// 读取时：如果不是完整URL，拼接腾讯云域名
afterFetch() {
    if (!Text::startsWith($this->cover, 'http')) {
        $this->cover = kg_cos_course_cover_url($this->cover);  // 拼接域名
    }
}
```

## 🚀 **外链上传解决方案**

### 方案一：修改前端支持外链输入（推荐）

#### 1.1 修改编辑页面模板
```html
<!-- 在 edit_basic.volt 中添加外链输入选项 -->
<div class="layui-form-item">
    <label class="layui-form-label">封面</label>
    <div class="layui-input-inline">
        <img id="img-cover" class="kg-cover" src="{{ course.cover }}">
        <input type="hidden" name="cover" value="{{ course.cover }}">
    </div>
    <div class="layui-input-inline" style="padding-top:35px;">
        <button id="change-cover" class="layui-btn layui-btn-sm" type="button">上传</button>
        <button id="external-cover" class="layui-btn layui-btn-sm layui-btn-normal" type="button">外链</button>
    </div>
</div>
```

#### 1.2 添加外链输入JavaScript
```javascript
// 添加到 cover.upload.js 或创建新的 JS 文件
$('#external-cover').click(function() {
    layer.prompt({
        title: '请输入封面图片外链地址',
        formType: 2, // 文本域
        area: ['500px', '150px'],
        value: $('input[name=cover]').val()
    }, function(value, index) {
        if (value && (value.startsWith('http://') || value.startsWith('https://'))) {
            $('#img-cover').attr('src', value);
            $('input[name=cover]').val(value);
            layer.close(index);
            layer.msg('封面外链设置成功', {icon: 1});
        } else {
            layer.msg('请输入有效的HTTP/HTTPS链接', {icon: 2});
        }
    });
});
```

### 方案二：数据库直接批量更新

#### 2.1 创建批量更新脚本
```php
<?php
// course_cover_external.php
```

### 方案三：后台管理扩展

#### 3.1 添加封面管理页面
在后台添加专门的封面管理功能，支持：
- 批量上传封面
- 外链导入
- 封面预览和管理

## 📋 **推荐实施步骤**

### 🎯 **快速方案：数据库直接更新**

最简单的方法是直接在数据库中更新封面字段：

```sql
-- 直接设置课程封面为MinIO外链
UPDATE kg_course 
SET cover = 'http://192.168.1.24:9000/course-files/covers/course-1.jpg' 
WHERE id = 1;

-- 批量更新多个课程封面
UPDATE kg_course 
SET cover = CONCAT('http://192.168.1.24:9000/course-files/covers/course-', id, '.jpg')
WHERE id IN (1,2,3,4,5);
```

### 🔧 **完整方案：前端支持外链**

如果需要在后台界面支持外链输入，需要修改前端代码。

## 💻 **实用脚本**

### 脚本1：课程封面外链批量设置
```php
<?php
// 设置课程封面为MinIO外链
```

### 脚本2：封面链接测试工具
```php
<?php
// 测试封面链接是否可访问
```

## ⚠️ **注意事项**

### 1. URL格式要求
- **支持格式**: `http://` 或 `https://` 开头的完整URL
- **存储方式**: 系统会自动处理，完整URL在保存时提取路径，读取时拼接域名
- **兼容性**: 外链URL会直接存储和使用，不经过腾讯云处理

### 2. 图片要求
- **格式**: JPG, PNG, GIF等常见图片格式
- **尺寸**: 建议 400x300 像素或等比例
- **大小**: 建议不超过2MB
- **访问**: 确保外链图片可以公开访问

### 3. 系统兼容性
- **现有机制**: 完全兼容现有的腾讯云COS上传
- **混合使用**: 可以同时使用本地上传和外链
- **数据迁移**: 不影响现有课程的封面显示

## 🎯 **快速开始**

### 最简单的方法：
1. **准备封面图片**: 上传到MinIO或其他图床
2. **获取外链地址**: 确保可以公开访问
3. **数据库更新**: 使用SQL直接更新
4. **验证效果**: 在前台查看封面显示

### SQL示例：
```sql
-- 更新单个课程封面
UPDATE kg_course 
SET cover = 'http://192.168.1.24:9000/course-files/covers/medical-equipment.jpg'
WHERE id = 1;

-- 查看更新结果
SELECT id, title, cover FROM kg_course WHERE id = 1;
```

需要我为您创建具体的实施脚本吗？
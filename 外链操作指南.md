# MinIO视频外链操作指南

## 🎯 准备工作

### 1. 确保MinIO服务器可访问
- MinIO服务器必须能够通过HTTP/HTTPS公网访问
- 视频文件已上传到MinIO指定bucket中
- 记录MinIO的访问地址和bucket名称

### 2. 确保数据库连接
- 获取酷瓜云课堂数据库的连接信息
- 确保有读写权限

### 3. 创建课程和章节
- 在酷瓜云课堂后台创建课程
- 为课程添加章节（选择"点播"模式）
- 记录章节ID

## 📝 具体操作步骤

### 第一步：修改配置信息

编辑 `minio_external_link.php` 文件，修改以下配置：

```php
$config = [
    // MinIO配置
    'minio' => [
        'endpoint' => 'http://你的MinIO服务器:9000',  // 替换为实际地址
        'bucket' => '你的bucket名称'                 // 替换为实际bucket
    ],
    
    // 数据库配置
    'database' => [
        'host' => '数据库主机',                      // 如: localhost
        'port' => 3306,                            // 数据库端口
        'dbname' => 'ctc',                         // 数据库名称
        'username' => '数据库用户名',               // 如: ctc
        'password' => '数据库密码'                  // 如: 1qaz2wsx3edc
    ]
];
```

### 第二步：配置视频列表

在脚本中找到 `$videoList` 数组，按以下格式添加您的视频：

```php
$videoList = [
    [
        'chapter_id' => 1,                         // 章节ID（从后台或数据库获取）
        'minio_path' => 'videos/lesson1.mp4',     // MinIO中的完整路径
        'video_info' => [
            'duration' => ['hours' => 0, 'minutes' => 30, 'seconds' => 0]  // 视频时长
        ]
    ],
    [
        'chapter_id' => 2,
        'minio_path' => 'videos/lesson2.mp4',
        'video_info' => [
            'duration' => ['hours' => 1, 'minutes' => 15, 'seconds' => 30]
        ]
    ]
    // 继续添加更多视频...
];
```

### 第三步：获取章节ID

有两种方法获取章节ID：

#### 方法1：运行脚本查看
```bash
php minio_external_link.php
```
脚本会显示所有现有章节的ID和标题。

#### 方法2：直接查询数据库
```sql
SELECT id, course_id, title FROM kg_chapter WHERE model = 1 ORDER BY course_id, sort;
```

### 第四步：执行脚本

```bash
php minio_external_link.php
```

脚本会：
1. 测试数据库连接
2. 测试MinIO服务器连接
3. 显示现有章节列表
4. 询问是否继续处理
5. 批量添加外链视频

## 📋 示例场景

### 场景1：单个课程的视频

假设您有一个课程，包含3个章节：

```php
// 1. 先在后台创建课程和章节，假设得到章节ID: 10, 11, 12
// 2. MinIO中的视频路径：
//    - course1/intro.mp4
//    - course1/chapter1.mp4  
//    - course1/chapter2.mp4

$videoList = [
    [
        'chapter_id' => 10,
        'minio_path' => 'course1/intro.mp4',
        'video_info' => ['duration' => ['hours' => 0, 'minutes' => 10, 'seconds' => 0]]
    ],
    [
        'chapter_id' => 11,
        'minio_path' => 'course1/chapter1.mp4',
        'video_info' => ['duration' => ['hours' => 0, 'minutes' => 45, 'seconds' => 0]]
    ],
    [
        'chapter_id' => 12,
        'minio_path' => 'course1/chapter2.mp4',
        'video_info' => ['duration' => ['hours' => 1, 'minutes' => 20, 'seconds' => 0]]
    ]
];
```

### 场景2：多个课程的视频

```php
$videoList = [
    // 课程A的视频
    [
        'chapter_id' => 20,
        'minio_path' => 'courseA/lesson1.mp4',
        'video_info' => ['duration' => ['hours' => 0, 'minutes' => 30, 'seconds' => 0]]
    ],
    [
        'chapter_id' => 21,
        'minio_path' => 'courseA/lesson2.mp4',
        'video_info' => ['duration' => ['hours' => 0, 'minutes' => 25, 'seconds' => 0]]
    ],
    
    // 课程B的视频
    [
        'chapter_id' => 30,
        'minio_path' => 'courseB/intro.mp4',
        'video_info' => ['duration' => ['hours' => 0, 'minutes' => 15, 'seconds' => 0]]
    ]
];
```

## 🔧 常见问题解决

### Q1: 数据库连接失败
```
✗ 数据库连接失败: SQLSTATE[HY000] [2002] Connection refused
```
**解决方法：**
- 检查数据库主机地址和端口
- 确认数据库服务是否启动
- 检查用户名和密码是否正确

### Q2: MinIO服务器无法访问
```
✗ MinIO服务器无法访问 (HTTP Code: 0)
```
**解决方法：**
- 确认MinIO服务器地址是否正确
- 检查MinIO服务是否启动
- 确认网络连接是否正常
- 检查防火墙设置

### Q3: 章节不存在
```
✗ 章节 123 不存在
```
**解决方法：**
- 先运行脚本查看现有章节列表
- 确认章节ID是否正确
- 检查章节是否为点播模式（model=1）

### Q4: 视频无法播放
**可能原因：**
- MinIO服务器无法公网访问
- 视频文件路径错误
- 视频格式不支持

**解决方法：**
- 在浏览器中直接访问生成的外链地址测试
- 检查MinIO中的文件路径是否正确
- 确认视频格式为常见格式（mp4, avi, mov等）

## 🎥 验证结果

### 1. 数据库验证
```sql
-- 查看VOD记录
SELECT * FROM kg_chapter_vod WHERE chapter_id IN (你的章节ID);

-- 查看章节状态
SELECT id, title, attrs FROM kg_chapter WHERE id IN (你的章节ID);
```

### 2. 前端验证
- 登录酷瓜云课堂后台
- 进入课程管理 → 章节管理
- 查看章节是否显示"外链云点播"标签
- 点击预览测试视频播放

### 3. 外链地址验证
生成的外链格式：`http://你的MinIO地址:端口/bucket名称/视频路径`

例如：`http://192.168.1.100:9000/videos/course1/lesson1.mp4`

## 📊 批量处理建议

### 大量视频处理
- 建议每次处理50个视频以内
- 可以分批次执行脚本
- 记录处理进度，避免重复操作

### 脚本执行日志
脚本会输出详细的执行日志：
```
MinIO视频外链添加工具
==================
✓ 数据库连接成功

=== 测试MinIO连接 ===
测试URL: http://192.168.1.100:9000/videos/test.txt
✓ MinIO服务器可访问

=== 现有章节列表 ===
章节ID: 1 | 课程ID: 1 | 标题: 课程介绍 | 时长: 未设置
章节ID: 2 | 课程ID: 1 | 标题: 第一章 | 时长: 未设置

是否继续添加外链视频？(y/n): y

=== 开始批量处理 ===

进度: 1/2

--- 处理章节 1 ---
MinIO路径: course1/intro.mp4
外链地址: http://192.168.1.100:9000/videos/course1/intro.mp4
章节标题: 课程介绍
✓ 创建VOD外链记录成功
✓ 更新章节状态和时长成功

进度: 2/2

--- 处理章节 2 ---
MinIO路径: course1/lesson1.mp4
外链地址: http://192.168.1.100:9000/videos/course1/lesson1.mp4
章节标题: 第一章
✓ 创建VOD外链记录成功
✓ 更新章节状态和时长成功

=== 处理完成 ===
成功: 2 个
失败: 0 个
```

---

**重要提醒：**
1. 操作前请备份数据库
2. 先在测试环境验证
3. 确保MinIO服务器稳定可访问
4. 记录好章节ID和视频路径的对应关系